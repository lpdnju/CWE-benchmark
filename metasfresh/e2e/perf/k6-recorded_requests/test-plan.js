/*
 * #%L
 * master
 * %%
 * Copyright (C) 2025 metas GmbH
 * %%
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as
 * published by the Free Software Foundation, either version 2 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public
 * License along with this program. If not, see
 * <http://www.gnu.org/licenses/gpl-2.0.html>.
 * #L%
 */

import http from 'k6/http';
import { check } from 'k6';

// Configuration via environment
const BASE_URL = __ENV.BASE_URL;
const AUTHORIZATION = __ENV.AUTHORIZATION;

// Validate base URL
if (!BASE_URL) {
  throw new Error('BASE_URL environment variable is required, e.g. BASE_URL=https://api.example.com');
}

// Load compiled requests (generated by scripts/compile-requests.js)
const compiled = JSON.parse(open('./compiled-requests.json'));

// k6 options: by default, run once; override as needed
export const options = {
  vus: 1,
  iterations: 1,
};

function joinUrl(base, p) {
  if (!p) return base;
  const baseTrim = base.endsWith('/') ? base.slice(0, -1) : base;
  const path = p.startsWith('/') ? p : `/${p}`;
  return `${baseTrim}${path}`;
}

function buildHeaders(hasBody, perRequestHeaders) {
  const headers = Object.assign({}, perRequestHeaders || {});
  if (AUTHORIZATION && !headers.Authorization) {
    headers.Authorization = `${AUTHORIZATION}`;
  }
  if (hasBody) {
    if (!headers['Content-Type']) {
      headers['Content-Type'] = 'application/json';
    }
  }
  return headers;
}

function sendRequest(req) {
  const method = String(req.method || '').toUpperCase();
  if (!method) {
    throw new Error('Request missing method');
  }
  const url = joinUrl(BASE_URL, req.path);
  const hasBody = ['POST', 'PUT', 'PATCH'].includes(method);
  const headers = buildHeaders(hasBody, req.headers);
  const params = { headers };

  const body = hasBody ? JSON.stringify(req.body != null ? req.body : {}) : null;

  const res = http.request(method, url, body, params);

  // basic check: HTTP 2xx or 3xx is OK
  check(res, {
    'status is OK (2xx/3xx)': (r) => r.status >= 200 && r.status < 400,
  });

  return res;
}

export function setup() {
  // Already loaded at init via open(); just return for default() to consume.
  return { requests: compiled };
}

export default function (data) {
  const { requests } = data;

  for (let i = 0; i < requests.length; i += 1) {
    const req = requests[i];
    sendRequest(req);
  }
}
